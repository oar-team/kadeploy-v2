#!/usr/bin/perl

use File::Copy;
use Getopt::Long;
use libkadeploy2::deployconf;
use libkadeploy2::deploy_iolib;
use libkadeploy2::command;
use libkadeploy2::message;
use libkadeploy2::nodelist;
use libkadeploy2::cmdline;
use libkadeploy2::karights;
use libkadeploy2::sudo;
use strict;
use warnings;

sub execcmd($$$);
sub check_options;
sub check_rights();


my $conf=libkadeploy2::deployconf::new();
if (! $conf->loadcheck()) { exit 1; }

my $sudo_user=libkadeploy2::sudo::get_sudo_user();
if (! $sudo_user) { $sudo_user=libkadeploy2::sudo::get_user(); }

my @node_list;
my $node_file;
my $node;
my $env;
my $soft;
my $hard;
my $deploy;
my $noreboot;
my $device;
my $verbose=0;
my $refnodelist;
my $command;
my $cmd;
my $nodeshell;
my $nodelist;
my $help;
my $message=libkadeploy2::message::new();
my $kadeploydir=$conf->get("kadeploy2_directory");


check_options();
if ($help) { $message->kareboot_help(); exit 0; }
if (! check_rights()) { $message->message(2,"$sudo_user not allowed to REBOOT ".$nodelist->get_str()); exit 1; }

if ($soft)
{
    if (execcmd($nodelist,"softboot",$verbose))
    { exit 0; }
    else
    { exit 1; }
}

if ($hard)
{
    if (execcmd($nodelist,"hardboot",$verbose))
    { exit 0; }
    else
    { exit 1; }
}

if (!execcmd($nodelist,"softboot",$verbose))
{
    if (!execcmd($nodelist,"hardboot",$verbose))
    { 	exit 1;     }
    else
    {	exit 0;     }
}
else
{     exit 0; }

################################################################################

sub check_rights()
{
    return libkadeploy2::karights::check_rights($nodelist,"REBOOT");
}



sub execcmd($$$)
{
    my $nodelist=shift;
    my $cmdnode=shift;
    my $verbose=shift;
    my $refnodelist;
    my @node_list;
    my $ok=1;
    
    $refnodelist=$nodelist->get_nodes();
    @node_list=@$refnodelist;

    foreach $node (@node_list)
    {
	$cmd=$conf->getpath_cmd("kaexec")." --confcommand -m ".$node->get_name()." -c $cmdnode";
	$command=libkadeploy2::command::new($cmd,5,$verbose);
	$command->exec();
	if (! $command->get_status())
	{ 
	    $message->message(0,$sudo_user." ".$cmdnode." ".$node->get_name()." fail");
	    $ok=0; 
	}
	else
	{
	    $message->message(0,$sudo_user." ".$cmdnode." ".$node->get_name()." success");
	}
    }
    return $ok;
}

sub check_options()
{

    GetOptions(
	       'm=s'           => \@node_list,
	       'machine=s'     => \@node_list,
	       'f=s'           => \$node_file,

	       'e=s'           => \$env,
	       'environment=s' => \$env,

	       's'             => \$soft,
	       'soft'          => \$soft,

	       'h'             => \$hard,
	       'hard'          => \$hard,

	       'd'             => \$deploy,
	       'deploy'        => \$deploy,

	       'n'             => \$noreboot,
	       'noreboot'      => \$noreboot,

	       'p=s'           => \$device,
	       'partition=s'   => \$device,

	       'verbose'       => \$verbose,
	       'v'             => \$verbose,

	       'help!'         => \$help,
	       'h!'            => \$help,
	       );


    if (@node_list) 
    { 
	$nodelist=libkadeploy2::nodelist::new();
	$nodelist=libkadeploy2::cmdline::loadhostcmdlineifexist(\@node_list); 
    }


    if (!scalar($nodelist))
    {
	$message->kareboot_help();
	exit 0;
    }
    


    if ($soft && $hard)
    {
	print "ERROR : soft and hard reboot options are exclusive\n";
	print "ERROR : please select only one of them at once\n";
	exit 1;
    }
    
    if (($noreboot && $soft) || ($noreboot && $hard))
    {
	print "ERROR : no reboot and soft or hard reboot should be exclusive\n";
	print "ERROR : please select only one of them at once\n";
	exit 1;
    }
    
    if (($deploy && $env) || ($deploy && $device) || ($env && $device))
    {
	print "ERROR : please select EITHER a deployment reboot OR a reboot on a partition OR a reboot on an environment\n";
	exit 1;
    }

    
}
