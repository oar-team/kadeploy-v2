#!/usr/bin/perl

use File::Copy;
use Getopt::Long;
use libkadeploy2::deployconf;
use libkadeploy2::deploy_iolib;
use libkadeploy2::rights_iolib;
use libkadeploy2::command;
use libkadeploy2::message;
use libkadeploy2::karights;
use libkadeploy2::sudo;
use libkadeploy2::nodelist;
use strict;
use warnings;

sub check_options();
sub check_rights();

my $sudo_user;
my $conf=libkadeploy2::deployconf::new();
if (! $conf->loadcheck()) { exit 1; }

my $message=libkadeploy2::message::new();



my $node;
my $nodelist;
my @node_list;
my $command;
my $cmd;
my $kadeploydir=$conf->get("kadeploy2_directory");

check_options();
if (! check_rights()) { $message->message(2,"$sudo_user not allowed to kaconsole  ".$nodelist->get_str()); exit 1; }

$cmd=$conf->getpath_kaexec()." --confcommand -m $node -c console";

$command=libkadeploy2::command::new($cmd,20,0);
$command->exec();
if ($command->get_status())
{
    exit 0;
}
else
{
    $message->commandnodenamefailed(2,"console",$node);
    exit 1;
}

################################################################################


sub check_rights()
{
    $sudo_user=libkadeploy2::sudo::get_sudo_user();
    if (! $sudo_user) { $sudo_user=libkadeploy2::sudo::get_user(); }
    my $ok=0;
    if ( $sudo_user eq "root" ||
	 $sudo_user eq $conf->get("deploy_user")
	 )
    {
	$ok=1;
    }
    if (libkadeploy2::karights::check($sudo_user,
				      $nodelist->get_node(0),
				      "CONSOLE"))
    {
	$ok=1;
    }	
    return $ok;
}

sub check_options()
{
    
    GetOptions('m=s'           => \$node,
	       'machine=s'     => \$node,
	       );	

    if (!$node)
    {
	$message->kaconsole_help();
	exit 0;
    }
    else
    {
	@node_list=($node);
	$nodelist=libkadeploy2::nodelist::new();
	$nodelist->loadlist(\@node_list);
    }
}

